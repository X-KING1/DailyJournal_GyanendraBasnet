@page "/login"
@inject ISecurityService SecurityService
@inject IDatabaseService DatabaseService
@inject NavigationManager Navigation

<PageTitle>Login - My Journal</PageTitle>

<div class="min-h-screen flex items-center justify-center bg-surface-50 bg-gradient-mesh">

    <!-- Login Card -->
    <div class="glass-card p-8 animate-slide-up" style="width: 100%; max-width: 420px;">
        
        <!-- Premium Logo -->
        <div class="text-center mb-8">
            <img src="images/logo.png" alt="My Journal" 
                 class="w-20 h-20 mx-auto rounded-2xl mb-5 shadow-lg" 
                 style="box-shadow: 0 15px 30px -5px rgba(139, 92, 246, 0.4);" />
            <h1 class="text-2xl font-bold gradient-text">My Journal</h1>
            <p class="text-gray-500 mt-2 text-sm">
                @(_isSettingPassword ? "Create a password to protect your memories" : "Welcome back! Enter your password")
            </p>
        </div>

        <!-- Form -->
        <div class="space-y-5">
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">üîë Password</label>
                <input type="password" 
                       @bind="_password" 
                       @onkeypress="HandleKeyPress"
                       class="input-premium"
                       placeholder="Enter your password..." />
            </div>

            @if (_isSettingPassword)
            {
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üîê Confirm Password</label>
                    <input type="password" 
                           @bind="_confirmPassword" 
                           class="input-premium"
                           placeholder="Confirm your password..." />
                </div>
            }

            <button @onclick="HandleLogin" class="btn-primary w-full" style="margin-top: 24px;">
                @(_isSettingPassword ? "üöÄ Get Started" : "üîì Unlock Journal")
            </button>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert-error animate-slide-down">
                    ‚ö†Ô∏è @_errorMessage
                </div>
            }

            @if (!string.IsNullOrEmpty(_successMessage))
            {
                <div class="alert-success animate-slide-down">
                    ‚úÖ @_successMessage
                </div>
            }
        </div>

        <!-- Footer -->
        <div class="text-center mt-8">
            <p class="text-xs text-gray-400 mb-3">üîê Secured with JWT Token Authentication</p>
            @if (!_isSettingPassword)
            {
                <button @onclick="ResetPassword" 
                        class="text-sm text-primary-600 hover:underline"
                        style="background: none; border: none; cursor: pointer;">
                    Forgot password? Reset here
                </button>
            }
        </div>
    </div>
</div>

@code {
    private string _password = string.Empty;
    private string _confirmPassword = string.Empty;
    private bool _isSettingPassword = false;
    private string _errorMessage = string.Empty;
    private string _successMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Check for existing valid JWT token first
        var tokenValid = await SecurityService.ValidateTokenAsync();
        if (tokenValid)
        {
            Navigation.NavigateTo("/");
            return;
        }
        
        _isSettingPassword = !await SecurityService.IsPasswordSetAsync();
        
        if (SecurityService.IsAuthenticated)
        {
            Navigation.NavigateTo("/");
        }
    }

    private async Task HandleLogin()
    {
        _errorMessage = string.Empty;
        _successMessage = string.Empty;

        try
        {
            await DatabaseService.InitializeDatabaseAsync();
            var user = await DatabaseService.GetCurrentUserAsync();
            
            if (_isSettingPassword)
            {
                if (string.IsNullOrWhiteSpace(_password) || _password.Length < 4)
                {
                    _errorMessage = "Password must be at least 4 characters";
                    return;
                }

                if (_password != _confirmPassword)
                {
                    _errorMessage = "Passwords do not match";
                    return;
                }

                await SecurityService.SetPasswordAsync(_password);
                
                // Generate JWT token
                await SecurityService.GenerateTokenAsync(user?.UserID ?? 1, user?.UserName ?? "User");
                SecurityService.Authenticate();
                
                Navigation.NavigateTo("/", true);
            }
            else
            {
                var isValid = await SecurityService.ValidatePasswordAsync(_password);
                if (isValid)
                {
                    // Generate JWT token on successful login
                    await SecurityService.GenerateTokenAsync(user?.UserID ?? 1, user?.UserName ?? "User");
                    SecurityService.Authenticate();
                    
                    Navigation.NavigateTo("/", true);
                }
                else
                {
                    _errorMessage = "Invalid password";
                    _password = string.Empty;
                }
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await HandleLogin();
        }
    }

    private async Task ResetPassword()
    {
        try
        {
            SecureStorage.Remove("journal_password_hash");
            SecurityService.Logout(); // Also remove JWT token
            _isSettingPassword = true;
            _successMessage = "Password reset! Set a new password below.";
            _errorMessage = string.Empty;
            _password = string.Empty;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error resetting: {ex.Message}";
        }
    }
}
