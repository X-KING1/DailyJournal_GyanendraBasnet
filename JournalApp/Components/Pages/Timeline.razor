@page "/timeline"
@inject IDatabaseService DatabaseService
@inject NavigationManager Navigation

<PageTitle>Timeline - My Journal</PageTitle>

<!-- Premium Page Header -->
<div class="mb-8 animate-fade-in">
    <div class="flex items-center gap-4 mb-3">
        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-pink-500 to-rose-600 
                    flex items-center justify-center shadow-lg shadow-rose-500/30 animate-pulse">
            <span class="text-3xl">üìú</span>
        </div>
        <div>
            <h1 class="text-3xl font-extrabold bg-gradient-to-r from-pink-600 via-rose-600 to-red-600 bg-clip-text text-transparent">
                Timeline
            </h1>
            <p class="text-gray-500 text-lg">Your journal history</p>
        </div>
    </div>
</div>

@if (_isLoading)
{
    <div class="p-8 rounded-3xl bg-white/70 backdrop-blur-xl animate-pulse">
        <div class="h-10 w-full bg-gray-200 rounded-xl mb-4"></div>
        @for (int i = 0; i < 5; i++)
        {
            <div class="h-14 w-full bg-gray-200 rounded-xl mb-2"></div>
        }
    </div>
}
else if (_entries.Any())
{
    <!-- Controls -->
    <div class="p-5 rounded-3xl bg-white/70 backdrop-blur-xl border border-white/20 
                shadow-xl mb-6 animate-slide-up">
        <div class="flex gap-4 items-center flex-wrap justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-500 to-purple-600 
                            flex items-center justify-center shadow-lg text-lg">‚öôÔ∏è</div>
                <label class="text-sm font-bold text-gray-700">Entries per page:</label>
                <select @bind="_pageSize" @bind:after="UpdatePage" 
                        class="px-4 py-2 rounded-xl border-2 border-purple-100 bg-white 
                               focus:border-purple-400 focus:ring-4 focus:ring-purple-100 
                               transition-all duration-300 font-medium cursor-pointer">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
            </div>
            <span class="px-4 py-2 rounded-xl bg-gradient-to-r from-violet-100 to-purple-100 text-purple-700 font-semibold">
                Total: <span class="font-black">@_entries.Count</span> entries
            </span>
        </div>
    </div>

    <!-- Entry Cards -->
    <div class="space-y-4 mb-6 animate-slide-up" style="animation-delay: 0.1s;">
        @foreach (var item in _pagedItems)
        {
            <div class="p-5 rounded-2xl bg-white/70 backdrop-blur-xl border border-white/20 
                        shadow-lg hover:shadow-xl hover:scale-[1.01] transition-all duration-300 cursor-pointer"
                 @onclick="@(() => Navigation.NavigateTo($"/entry/{item.Entry.Date:yyyy-MM-dd}"))">
                
                <!-- Header Row -->
                <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center gap-3">
                        <!-- Date Badge -->
                        <div class="p-3 rounded-xl bg-gradient-to-br from-violet-500 to-purple-600 text-white text-center min-w-[60px]">
                            <div class="text-lg font-bold">@item.Entry.Date.Day</div>
                            <div class="text-xs opacity-80">@item.Entry.Date.ToString("MMM")</div>
                        </div>
                        
                        <!-- Title & Meta -->
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">
                                @(string.IsNullOrWhiteSpace(item.Entry.Title) ? "Untitled Entry" : item.Entry.Title)
                            </h3>
                            <p class="text-sm text-gray-500">@item.Entry.Date.ToString("dddd, yyyy")</p>
                        </div>
                    </div>
                    
                    <!-- Mood Display -->
                    <div class="flex items-center gap-3 flex-wrap">
                        @if (item.PrimaryMood != null)
                        {
                            <div class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white border border-gray-200 shadow-md">
                                <span class="text-2xl">@item.PrimaryMood.Emoji</span>
                                <span class="font-bold text-gray-800">@item.PrimaryMood.MoodName</span>
                                @if (item.SecondaryMoods.Any())
                                {
                                    <span class="text-gray-400 mx-1">|</span>
                                    <span class="text-gray-500 text-sm">Also:</span>
                                    @foreach (var secMood in item.SecondaryMoods)
                                    {
                                        <span class="text-lg">@secMood.Emoji</span>
                                        <span class="text-sm text-gray-600">@secMood.MoodName@(secMood != item.SecondaryMoods.Last() ? "," : "")</span>
                                    }
                                }
                            </div>
                        }
                        <span class="px-3 py-2 rounded-xl bg-gray-100 text-gray-600 font-semibold text-sm">
                            @item.Entry.WordCount words
                        </span>
                    </div>
                </div>
                
                <!-- Content Preview -->
                <div class="p-4 rounded-xl bg-gray-50 border border-gray-100">
                    <div class="prose prose-sm max-w-none text-gray-600 line-clamp-2">
                        @((MarkupString)GetContentPreview(item.Entry.Content))
                    </div>
                </div>
                
                <!-- Footer with Edit Button -->
                <div class="flex justify-end mt-3">
                    <button class="px-4 py-2 rounded-xl bg-gradient-to-r from-violet-600 to-purple-600 text-white font-semibold text-sm
                                   shadow-md hover:shadow-lg hover:scale-105 active:scale-95 transition-all duration-300">
                        ‚úèÔ∏è View & Edit
                    </button>
                </div>
            </div>
        }
    </div>

    <!-- Premium Pagination -->
    <div class="flex gap-4 items-center justify-center animate-slide-up" style="animation-delay: 0.2s;">
        <button @onclick="PreviousPage" disabled="@(_currentPage <= 1)" 
                class="px-5 py-2 rounded-xl bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 font-semibold
                       hover:from-violet-100 hover:to-purple-100 hover:text-purple-700 
                       hover:scale-105 active:scale-95 transition-all duration-300
                       disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
            ‚Üê Previous
        </button>
        <div class="px-5 py-2 rounded-xl bg-gradient-to-r from-violet-500 to-purple-600 text-white font-bold shadow-lg">
            @_currentPage / @_totalPages
        </div>
        <button @onclick="NextPage" disabled="@(_currentPage >= _totalPages)" 
                class="px-5 py-2 rounded-xl bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 font-semibold
                       hover:from-violet-100 hover:to-purple-100 hover:text-purple-700 
                       hover:scale-105 active:scale-95 transition-all duration-300
                       disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
            Next ‚Üí
        </button>
    </div>
}
else
{
    <!-- Empty State -->
    <div class="p-12 rounded-3xl bg-white/70 backdrop-blur-xl border border-white/20 
                shadow-xl text-center animate-slide-up">
        <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-violet-500 to-purple-600 
                    flex items-center justify-center shadow-lg mx-auto mb-6">
            <span class="text-4xl">üìù</span>
        </div>
        <h3 class="text-2xl font-bold text-gray-800 mb-3">No journal entries yet</h3>
        <p class="text-gray-500 mb-6">Start documenting your thoughts and feelings</p>
        <a href="/entry" 
           class="inline-block px-8 py-3 rounded-xl bg-gradient-to-r from-violet-600 to-purple-600 text-white font-bold
                  shadow-lg shadow-purple-500/30 hover:shadow-xl hover:scale-105 
                  active:scale-95 transition-all duration-300">
            ‚úèÔ∏è Create your first entry!
        </a>
    </div>
}

@code {
    private List<JournalEntry> _entries = new();
    private List<EntryDisplayItem> _pagedItems = new();
    private bool _isLoading = true;
    private int _pageSize = 10;
    private int _currentPage = 1;
    private int _totalPages => (int)Math.Ceiling((double)_entries.Count / _pageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadEntries();
    }

    private async Task LoadEntries()
    {
        _isLoading = true;
        try
        {
            await DatabaseService.InitializeDatabaseAsync();
            _entries = await DatabaseService.GetAllEntriesAsync();
            await UpdatePage();
        }
        catch (Exception)
        {
            // Error loading entries
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task UpdatePage()
    {
        var pagedEntries = _entries
            .Skip((_currentPage - 1) * _pageSize)
            .Take(_pageSize)
            .ToList();
        
        _pagedItems.Clear();
        foreach (var entry in pagedEntries)
        {
            var primaryMood = await DatabaseService.GetPrimaryMoodForEntryAsync(entry.EntryID);
            var secondaryMoods = await DatabaseService.GetSecondaryMoodsForEntryAsync(entry.EntryID);
            _pagedItems.Add(new EntryDisplayItem
            {
                Entry = entry,
                PrimaryMood = primaryMood,
                SecondaryMoods = secondaryMoods
            });
        }
    }

    private async void PreviousPage()
    {
        if (_currentPage > 1)
        {
            _currentPage--;
            await UpdatePage();
            StateHasChanged();
        }
    }

    private async void NextPage()
    {
        if (_currentPage < _totalPages)
        {
            _currentPage++;
            await UpdatePage();
            StateHasChanged();
        }
    }

    private class EntryDisplayItem
    {
        public JournalEntry Entry { get; set; } = null!;
        public Mood? PrimaryMood { get; set; }
        public List<Mood> SecondaryMoods { get; set; } = new();
    }

    private string GetContentPreview(string? content)
    {
        if (string.IsNullOrWhiteSpace(content)) return "<em>No content written yet...</em>";
        // Return the HTML content directly (for styling), truncate if too long
        
        if (content.Length > 300)
        {
            return content.Substring(0, 300) + "...";
        }
        return content;
    }
}
